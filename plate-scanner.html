<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plate Scanner - Star Parking</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Tesseract for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body id="plate-scanner">
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-12" style="max-width: 1400px;">
                
                <!-- Header -->
                <div class="mb-4">
                    <h1 class="h2 fw-semibold mb-2">Scan a Number Plate and Find the Booking</h1>
                    <p class="text-muted">Runs in the browser. If camera access is blocked, use the Upload fallback and it will still read the plate.</p>
                </div>

                <div class="row g-4">
                    <!-- Left Column: Camera -->
                    <div class="col-12 col-lg-7">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">Camera</h5>
                                    <span id="permState" class="badge bg-secondary">state unknown</span>
                                </div>
                                
                                <!-- Environment Warning -->
                                <div id="envWarn" class="alert alert-warning d-none mb-3" role="alert">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span id="envWarnText"></span>
                                </div>

                                <!-- Camera Controls -->
                                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                                    <button id="startBtn" class="btn btn-primary">
                                        <i class="bi bi-camera-video me-1"></i>Start camera
                                    </button>
                                    <button id="stopBtn" class="btn btn-outline-secondary" disabled>
                                        <i class="bi bi-stop-circle me-1"></i>Stop camera
                                    </button>
                                    <select id="cameraSelect" class="form-select" style="width: auto; min-width: 150px;">
                                        <option>Select camera...</option>
                                    </select>
                                    <div class="form-check">
                                        <input id="autoCapture" class="form-check-input" type="checkbox" checked>
                                        <label class="form-check-label" for="autoCapture">Auto scan</label>
                                    </div>
                                </div>

                                <!-- Video Feed -->
                                <div class="position-relative mb-3">
                                    <video id="video" class="w-100 rounded bg-dark" style="height: 300px; object-fit: cover;" playsinline muted></video>
                                    <canvas id="frame" style="display: none;"></canvas>
                                </div>

                                <!-- Detection Results -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-medium">Last detected plate</label>
                                        <div id="lastPlate" class="plate-display">â€”</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-medium">Manual override</label>
                                        <div class="input-group">
                                            <input id="manualPlate" type="text" class="form-control" placeholder="Enter plate e.g. AB12 CDE" maxlength="10">
                                            <button id="lookupBtn" class="btn btn-primary" type="button">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="interval" class="form-label">Scan interval (ms)</label>
                                        <input id="interval" type="number" class="form-control" value="1500" min="500" step="100">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confidence" class="form-label">Confidence threshold</label>
                                        <input id="confidence" type="number" class="form-control" value="45" min="0" max="100">
                                    </div>
                                </div>

                                <!-- Scan Log -->
                                <div class="mb-3">
                                    <label class="form-label fw-medium">Scan log</label>
                                    <div id="log" class="scan-log"></div>
                                </div>

                                <!-- Upload Fallback -->
                                <div>
                                    <h6 class="fw-medium mb-2">Upload fallback</h6>
                                    <p class="text-muted small mb-2">If the camera is blocked or you are on an insecure origin, upload a photo of the plate.</p>
                                    <input id="fileInput" type="file" class="form-control" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Results & Info -->
                    <div class="col-12 col-lg-5">
                        
                        <!-- Booking Match -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Booking match</h5>
                                <div id="bookingBox" class="booking-result">
                                    <div class="text-muted text-center py-4">
                                        <i class="bi bi-search fs-1 text-muted d-block mb-2"></i>
                                        No booking yet
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- How it works -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">How it works</h5>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="bi bi-1-circle text-primary me-2"></i>
                                        We grab a frame from the camera or an uploaded image
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-2-circle text-primary me-2"></i>
                                        We run OCR and clean the result for UK plate formats
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-3-circle text-primary me-2"></i>
                                        On a confident match we call your API endpoint <code>/api/bookings?reg=</code>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- API Contract -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">API contract</h5>
                                <div class="api-example">
                                    <div class="mb-2">
                                        <span class="badge bg-success me-2">GET</span>
                                        <code>/api/bookings?reg=AB12CDE</code>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-light text-dark">Response 200</span>
                                    </div>
                                    <pre class="bg-light p-3 rounded"><code>{
  "reg": "AB12CDE",
  "status": "due in",
  "customer": "Jane Doe",
  "product": "Meet and Greet",
  "terminal": "T3",
  "arrival": "2025-10-12T19:30:00Z",
  "phone": "+44 7700 900123",
  "bookingId": "SP-391204"
}</code></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Self Tests -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Self tests</h5>
                                <p class="text-muted small mb-3">Normalise function tests will run on load. Results below.</p>
                                <pre id="testOutput" class="bg-light p-3 rounded small">Running testsâ€¦</pre>
                                <div class="form-check mt-3">
                                    <input id="mockToggle" class="form-check-input" type="checkbox">
                                    <label class="form-check-label" for="mockToggle">
                                        Mock API mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="app.js"></script>
</body>
</html>